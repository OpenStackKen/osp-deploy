#!/bin/bash

set -o pipefail
set -evx

# check to see if scripts have been configured already
if [ -f /home/stack/templates/000-UNCONFIGURED-000 ]; then
  echo "Please configure templates before running deploy-overcloud.sh script."
  echo "Once configured, remove the /home/stack/templates/000-UNCONFIGURED-000 file"
  echo "to allow the deploy-overcloud.sh script to continue..."
  exit 1
fi

# overcloud deploy script generated by osp-deploy
source /home/stack/stackrc

openstack overcloud deploy \
   --stack {{ overcloud_stack_name }} \
   --templates \
   --roles-file /home/stack/templates/roles_data.yaml \
   --networks-files /home/stack/network_data.yaml \
   -e /home/stack/templates/00-node-info.yaml \
   -e /home/stack/templates/01-overcloud-images.yaml \
   -e /usr/share/openstack-tripleo-heat-templates/environments/network-isolation.yaml \
   -e /home/stack/templates/20-network-environment.yaml \
{% if overcloud_external_lb_enabled | bool %}
   -e /home/stack/templates/30-external-loadbalancer-vip.yaml \ #ONLY FOR EXTERNAL LB DEPLOYMENTS
{% else %}
   -e /home/stack/templates/33-enable-tls.yaml \ #ONLY FOR HAPROXY DEPLOYMENTS
{% endif %}
   -e /home/stack/templates/31-inject-trust-anchor-hiera.yaml \
   -e /home/stack/templates/32-tls-endpoints-public-ip.yaml \
   -e /home/stack/templates/40-ips-from-pool-all.yaml \
{% if overcloud_barbican_enabled | bool %}
   -e /usr/share/openstack-tripleo-heat-templates/environments/services/barbican.yaml \
   -e /usr/share/openstack-tripleo-heat-templates/environments/barbican-backend-simple-crypto.yaml \
   -e /home/stack/templates/46-barbican-config.yaml \
   -e /home/stack/templates/47-container-parameters-with-barbican.yaml \
{% endif %}
{% if overcloud_ceph_enabled | bool %}
   -e /home/stack/templates/50-ceph-ansible.yaml \
   -e /home/stack/templates/51-ceph-config.yaml \
   -e /home/stack/templates/52-ceph-rgw.yaml \
{% endif %}
{% if overcloud_rackspace_tuning | bool %}
   -e /home/stack/templates/60-rackspace-tuning.yaml \
{% endif %}
{% if overcloud_rhn_enabled | bool %}
   # uncomment once successful deploy has occurred
   # -e /home/stack/templates/61-environment-rhel-registration.yaml \
   # -e /home/stack/templates/62-rhel-registration-resource-registry.yaml \
{% endif %}
{% if overcloud_octavia_enabled | bool %}
   -e /home/stack/templates/55-octavia.yaml \
   -e /usr/share/openstack-tripleo-heat-templates/environments/services-docker/octavia.yaml \
{% endif %}
{% if overcloud_sahara_enabled | bool %}
   -e /usr/share/openstack-tripleo-heat-templates/environments/services/sahara.yaml \
{% endif %}
{% if overcloud_manila_enabled | bool %}
   -e /usr/share/openstack-tripleo-heat-templates/environments/manila-cephfsnative-config.yaml \
   -e /usr/share/openstack-tripleo-heat-templates/environments/services/ceph-mds.yaml \
   -e /home/stack/templates/45-manila-ceph-config.yaml \
{% endif %}
{% if overcloud_ovn_enabled | bool %}
   -e /usr/share/openstack-tripleo-heat-templates/environments/services-docker/neutron-ovn-ha.yaml \
{% endif %}
   -e /home/stack/templates/99-server-blacklist.yaml \
   --ntp-server {{ undercloud_ntp_servers[0] }} \
   2>&1 | tee /home/stack/logs/overcloud_install.log
