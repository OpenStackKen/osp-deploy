#!/bin/bash

set -o pipefail
set -evx

# overcloud deploy script generated by osp-deploy
source /home/stack/stackrc
# NOTE(npawelek): Fixes an issue with Zaqar's hardcoded websocket certificate
export WEBSOCKET_CLIENT_CA_BUNDLE=/etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem

openstack overcloud deploy --templates \
   -e /home/stack/templates/00-node-info.yaml \
   -e /home/stack/templates/undercloud_ssl_camap.yaml \
   -e /home/stack/templates/overcloud_images.yaml \
{% if overcloud_ceph_enabled | bool %}
   -e /usr/share/openstack-tripleo-heat-templates/environments/ceph-ansible/ceph-ansible.yaml \
   -e /home/stack/templates/51-ceph-config.yaml \
   -e /home/stack/templates/52-storage-environment.yaml \
   -e /usr/share/openstack-tripleo-heat-templates/environments/ceph-ansible/ceph-rgw.yaml \
{% endif %}
{% if overcloud_octavia_enabled | bool %}
   -e /usr/share/openstack-tripleo-heat-templates/environments/services-docker/octavia.yaml \
{% endif %}
{% if overcloud_sahara_enabled | bool %}
   -e /usr/share/openstack-tripleo-heat-templates/environments/services/sahara.yaml \
{% endif %}
{% if overcloud_manila_enabled | bool %}
   -e /usr/share/openstack-tripleo-heat-templates/environments/manila-cephfsnative-config.yaml \
   -e /usr/share/openstack-tripleo-heat-templates/environments/services/ceph-mds.yaml \
   -e /home/stack/templates/45-manila-ceph-config.yaml \
{% endif %}
{% if overcloud_barbican_enabled | bool %}
   -e /usr/share/openstack-tripleo-heat-templates/environments/services/barbican.yaml \
   -e /usr/share/openstack-tripleo-heat-templates/environments/barbican-backend-simple-crypto.yaml \
   -e /home/stack/templates/46-barbican-config.yaml \
{% endif %}
{% if overcloud_ovn_enabled | bool %}
   -e /usr/share/openstack-tripleo-heat-templates/environments/services-docker/neutron-ovn-ha.yaml \
{% endif %}
   --ntp-server {{ undercloud_ntp_servers[0] }} \
   2>&1 | tee /home/stack/logs/overcloud_install.log
